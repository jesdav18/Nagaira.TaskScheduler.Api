name: .NET CI/CD

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # Paso 1: Checkout del código
    - uses: actions/checkout@v4

    # Paso 2: Configurar .NET
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    # Paso 3: Restaurar dependencias
    - name: Restore dependencies
      run: dotnet restore

    # Paso 4: Construir el proyecto
    - name: Build
      run: dotnet build --no-restore

    # Paso 5: Ejecutar pruebas
    - name: Test
      run: dotnet test --no-build --verbosity normal

    # Paso 6: Publicar la aplicación
    - name: Publish
      run: dotnet publish -c Release -o out

    # Paso 7: Desplegar a tu VPS
    - name: Deploy to VPS
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}   # Usamos el secreto SSH
        VPS_USERNAME: ${{ secrets.VPS_USERNAME }}
        VPS_IP: ${{ secrets.VPS_IP }}
        VPS_API_PATH: ${{ secrets.VPS_API_PATH }}
      run: |
        mkdir -p /tmp/deploy
        cp -r out/* /tmp/deploy/
        
        # Guardar la clave privada en un archivo temporal
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa  # Cambiar permisos de la clave para que sea accesible solo para el usuario

        # Verificar la conexión SSH (debug)
        ssh -v -p 2222 -i ~/.ssh/id_rsa $VPS_USERNAME@$VPS_IP "echo Connection successful"

        # Crear carpeta de destino en el VPS
        ssh -p 2222 -i ~/.ssh/id_rsa $VPS_USERNAME@$VPS_IP "mkdir -p $VPS_API_PATH"
        
        # Subir los archivos al VPS
        scp -P 2222 -i ~/.ssh/id_rsa -r /tmp/deploy/* $VPS_USERNAME@$VPS_IP:$VPS_API_PATH
        
        # Iniciar servicio en el VPS
        ssh -p 2222 -i ~/.ssh/id_rsa $VPS_USERNAME@$VPS_IP "sudo systemctl start api-task-scheduler.service"
