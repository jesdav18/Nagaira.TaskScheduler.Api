name: .NET CI/CD

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # Paso 1: Checkout del c贸digo
    - uses: actions/checkout@v4

    # Paso 2: Configurar .NET
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    # Paso 3: Restaurar dependencias
    - name: Restore dependencies
      run: dotnet restore

    # Paso 4: Construir el proyecto
    - name: Build
      run: dotnet build --no-restore

    # Paso 5: Ejecutar pruebas
    - name: Test
      run: dotnet test --no-build --verbosity normal

    # Paso 6: Publicar la aplicaci贸n
    - name: Publish
      run: dotnet publish -c Release -o out

    # Paso 7: Desplegar a tu VPS
    - name: Deploy to VPS
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}  # Secreto de la clave privada SSH
        VPS_USERNAME: ${{ secrets.VPS_USERNAME }}
        VPS_IP: ${{ secrets.VPS_IP }}
        VPS_API_PATH: ${{ secrets.VPS_API_PATH }}
      run: |
        # Paso 7.1: Crear el directorio de despliegue temporal
        mkdir -p /tmp/deploy
        cp -r out/* /tmp/deploy/

        # Paso 7.2: Configuraci贸n del SSH (agregar la clave privada al agente SSH)
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" | tee ~/.ssh/nagaira_ssh_pair > /dev/null
        chmod 700 ~/.ssh
        chmod 600 ~/.ssh/nagaira_ssh_pair

        # Paso 7.3: Iniciar el ssh-agent y agregar la clave privada
        eval $(ssh-agent -s)
        ssh-add ~/.ssh/nagaira_ssh_pair

        # Paso 7.4: Verificar la conexi贸n SSH (usando ssh-agent)
        ssh -v -p 2222 $VPS_USERNAME@$VPS_IP "echo Connection successful"

        # Paso 7.5: Crear la carpeta en el VPS para la API
        ssh -p 2222 $VPS_USERNAME@$VPS_IP "mkdir -p $VPS_API_PATH"
        
        # Paso 7.6: Subir los archivos al VPS
        scp -P 2222 -r /tmp/deploy/* $VPS_USERNAME@$VPS_IP:$VPS_API_PATH
        
        # Paso 7.7: Reiniciar o iniciar el servicio en el VPS
        ssh -p 2222 $VPS_USERNAME@$VPS_IP "sudo systemctl restart api-task-scheduler.service"
